# Build pipeline

Store Framework Jamstack (SFJ) CI flow consists of 4 main steps: 

- [Build](#build) - runs an automated build for the store and generates a deploy preview.
- [SonarQube](#sonarqube) - measures and analyzes code quality using static analysis.
- [Lighthouse CI](#lighthouse-ci) - provides insights on how performance changed with the new developments.
- [Integration Tests](#integration-tests) - implements integration tests with [Cypress.](https://www.cypress.io/)

![Store Framework Jamstack CI flow](./images/ci_flow.png)

Two situations trigger this CI flow:

1. Creating a pull request.
2. Making a git push to push commits associated with a pull request.

In both cases, GitHub creates a [check suite](https://docs.github.com/en/free-pro-team@latest/rest/guides/getting-started-with-the-checks-api#about-check-suites) and populates it with [check runs](https://docs.github.com/en/free-pro-team@latest/rest/guides/getting-started-with-the-checks-api#about-check-runs). 

![Store Framework Jamstack CI checks](./images/queued_check_runs.png)

Each of these check runs can have one of the following states, with each one of them indicating that the step:

- `queued` - will start being executed soon.
- `in_progress` - is being executed.
- `completed/success` - completed successfully.
- `completed/failure` - completed, but something went wrong.
- `completed/canceled` - couldn't be executed.
- `completed/neutral` - doesn't need to run.

>ℹ️ *The initial state of every step is `queued`.*

## Build

The Build step is responsible for two main actions:

- Building the store.
- Generating a deploy preview.

### Build the store

The Build step runs an automated build for the store, saving all the generated artifacts in the VTEX infrastructure. Then, the Build step sends all the build logs to GitHub. 

>ℹ️ *Once finished, you can click on the *Details* button next to the Build check run to check the build logs.*

![Store Framework Jamstack CI build check completed](./images/build_check_completed.png)

### Deploy preview 

For each pull request, the Build step generates a *Deploy Preview*.

>ℹ️ *A Deploy preview is a snapshot of what your store will look like after merging your latest deployments.*

Once the commit status updates to {store-name}/deploy-preview, you'll be able to access the *Deploy Preview* of a specific pull request by clicking on *Details* or directly on the URL: https://preview-{pull-request-number}--{store-name}.vtex.app/.

![Store Framework Jamstack CI deploy preview commit status](./images/deploy_preview_commit_status.png)

## SonarQube

[SonarQube](sonarqube.md) measures and analyzes code quality through [static analysis](https://en.wikipedia.org/wiki/Static_program_analysis).

If the test detects any issues in the code of a given pull request, SonarQube provides annotations as in the following:

![Store Framework Jamstack CI sonarqube annotations](./images/sonarqube_annotation.png)

## Lighthouse CI

Lighthouse CI executes [Lighthouse](https://developers.google.com/web/tools/lighthouse) each time a new build is completed, providing insights on how the performance varied with the pull request changes.

>ℹ️ *[Lighthouse](https://developers.google.com/web/tools/lighthouse) is an open-source, automated tool created by Google, capable of identifying common problems related to the quality of a webpage through audits.*

As the source of analysis, the Lighthouse CI uses the Deploy Preview generated by the Build step.

This way, the test results can be used to compare what is being developed with what is in production.

>ℹ️ *Once finished, you can click on the *Details* button next to the Lighthouse check run to check the execution logs.*

## Integration Tests

Integration tests evaluate the project compliance by combining individual applications and testing them as a group. 

SFJ CI flow supports integration tests implemented with [Cypress.](https://www.cypress.io/)

After completing the Build step, SFJ CI flow executes the integrations tests with the URL generated by the Deploy Preview.

>ℹ️ *Once finished, you can click on the *Details* button next to the Integration Tests check run to check the test results.*

![Store Framework Jamstack CI integration tests check completed](./images/integration_tests_check_completed.png)

![Store Framework Jamstack CI integration tests results](./images/integration_tests_results.png)

>ℹ️ *For more information on how to to write end-to-end (E2E) tests for modern web applications with Cypress, follow [this link.](./e2e-testing.md)*
